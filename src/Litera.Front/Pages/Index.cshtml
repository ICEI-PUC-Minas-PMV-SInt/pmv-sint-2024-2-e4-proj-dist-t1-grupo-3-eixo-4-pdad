@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
    var apiURl = (string)ViewData["ApiUrl"];
}

<h1>Autores</h1>

<div class="container mb-3">
    <form id="autor-form" onsubmit="event.preventDefault(); salvarAutor();">
        <input type="hidden" id="autor-id">
        <div class="mb-3">
            <label for="nomeCompleto" class="form-label">Nome Completo</label>
            <input type="text" class="form-control" id="nomeCompleto" placeholder="Digite o nome Completo" required>
        </div>

        <div class="mb-3">
            <label for="dataNascimento" class="form-label">Data de Nascimento</label>
            <input type="date" class="form-control" id="dataNascimento" required>
        </div>
        <div class="mb-3">
            <label for="nacionalidade" class="form-label">Nacionalidade</label>
            <input type="text" class="form-control" id="nacionalidade" placeholder="Digite a nacionalidade" required>
        </div>
        <div class="mb-3">
            <label for="biografia" class="form-label">Biografia</label>
            <textarea class="form-control" id="biografia" rows="3" placeholder="Escreva uma breve biografia"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Salvar</button>
    </form>
</div>

<div class="container">
    <ul class="list-group" id="lista-autores"></ul>
</div>

<script>
    const apiUrl = `@(apiURl)`;

    async function fetchAutores() {
        const response = await fetch(`${apiUrl}/api/Autores`);
        const autores = await response.json();
        const listaAutores = document.getElementById("lista-autores");
        listaAutores.innerHTML = "";
        autores.forEach(autor => { // Corrigido para forEach
            let li = document.createElement('li');
            li.className = "list-group-item d-flex justify-content-between align-items-center"; // Corrigido para list-group-item
            li.innerHTML = `
                    <span> ${autor.NomeCompleto} </span>
                    <div>
                        <button class="btn btn-sm btn-warning" onclick="editarAutor(${autor.id})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="deletarAutor(${autor.id})">Deletar</button>
                    </div>
                `;
            listaAutores.appendChild(li);
        });
    }

    async function salvarAutor() {
        console.log("entrou aqui");
        const id = document.getElementById("autor-id").value;
        const nomeCompleto = document.getElementById("nomeCompleto").value;
        const dataNascimento = document.getElementById("dataNascimento").value;
        const nacionalidade = document.getElementById("nacionalidade").value;
        const biografia = document.getElementById("biografia").value;

        const autor = { nomeCompleto, dataNascimento, nacionalidade, biografia };

        if (id) {
            await fetch(`${apiUrl}/api/Autores/${id}`, {
                method: "PUT",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: parseInt(id), ...autor })
            });
        } else {
            await fetch(`${apiUrl}/api/Autores`, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(autor) // Corrigido para JSON.stringify
            });
        }

        // Limpar os campos do formulário
        document.getElementById("autor-id").value = '';
        document.getElementById("nomeCompleto").value = '';
        document.getElementById("dataNascimento").value = '';
        document.getElementById("nacionalidade").value = '';
        document.getElementById("biografia").value = '';

        fetchAutores();
    }

    async function editarAutor(id) {
        const response = await fetch(`${apiUrl}/api/Autores/${id}`);
        const autor = await response.json();

        document.getElementById("autor-id").value = autor.id;
        document.getElementById("nomeCompleto").value = autor.NomeCompleto;
        document.getElementById("dataNascimento").value = autor.dataNascimento;
        document.getElementById("nacionalidade").value = autor.nacionalidade;
        document.getElementById("biografia").value = autor.biografia;
    }

    async function deletarAutor(id) {
        await fetch(`${apiUrl}/api/Autores/${id}`, {
            method: "DELETE"
        });
        fetchAutores();
    }

    window.onload = fetchAutores;
</script>
